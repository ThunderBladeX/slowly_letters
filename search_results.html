{% extends "base.html" %}

{% block title %}Search Results - Slowly Letters Organizer{% endblock %}

{% block content %}
    <a href="{{ url_for('index') }}" class="back-link">← Return to all pen pals</a>
    
    <div class="card">
        <h2 style="margin-bottom: 15px; color: #5a5a5a; font-weight: 400;">Search Results</h2>
        {% if query %}
            <p style="color: #8a8a8a; margin-bottom: 25px; font-weight: 300;">
                Found in letters containing "<strong style="color: #5a5a5a;">{{ query }}</strong>"
            </p>
        {% endif %}
        
        <!-- Search Box -->
        <div class="form-group">
            <input type="text" class="search-box" placeholder="Search through your letters..." 
                   value="{{ query }}" onkeyup="searchLetters(this.value)">
        </div>
    </div>

    {% if results %}
        <div style="margin-bottom: 25px;">
            <div class="stat-card" style="display: inline-block; margin-right: 20px;">
                <span class="stat-number">{{ results|length }}</span>
                <span class="stat-label">Result{{ 's' if results|length != 1 else '' }} Found</span>
            </div>
        </div>

        {% for result in results %}
            <div class="search-result">
                <div class="search-result-header">
                    <div>
                        <span class="search-result-penpal">{{ result.penpal_name }}</span>
                        <span class="search-result-country">from {{ result.country }}</span>
                    </div>
                    <div class="search-result-date">
                        {{ result.letter.date_received[:10] if result.letter.date_received else 'Unknown date' }}
                    </div>
                </div>
                <div class="search-result-preview">
                    {{ result.preview }}
                </div>
                <div style="margin-top: 15px;">
                    <a href="{{ url_for('penpal_details', penpal_name=result.penpal_name) }}" class="btn btn-secondary" style="font-size: 0.9rem; padding: 10px 18px;">
                        View {{ result.penpal_name }}'s Letters
                    </a>
                </div>
            </div>
        {% endfor %}
    {% else %}
        {% if query %}
            <div class="card">
                <div class="no-data">
                    <h3>No results found</h3>
                    <p>Your letters don't contain the text "{{ query }}"</p>
                    <br>
                    <div style="color: #8a8a8a; font-size: 0.95rem; font-weight: 300; text-align: left; max-width: 400px; margin: 0 auto;">
                        <p style="margin-bottom: 10px;">Try searching for:</p>
                        <p style="margin-bottom: 8px;">• Different keywords or phrases</p>
                        <p style="margin-bottom: 8px;">• Parts of words (like "happ" instead of "happy")</p>
                        <p>• Topics or subjects mentioned in letters</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="no-data">
                    <h3>Begin Your Search</h3>
                    <p>Enter words or phrases above to discover letters containing specific content.</p>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <script>
        // Highlight search terms in results
        document.addEventListener('DOMContentLoaded', function() {
            const query = '{{ query }}';
            if (query) {
                const previews = document.querySelectorAll('.search-result-preview');
                previews.forEach(preview => {
                    const regex = new RegExp(`(${query})`, 'gi');
                    preview.innerHTML = preview.innerHTML.replace(regex, '<mark style="background: rgba(255, 215, 0, 0.3); padding: 2px 6px; border-radius: 4px; color: #5a5a5a;">$1</mark>');
                });
            }
        });

        // Enhanced search function with enter key support
        function searchLetters(query) {
            if (query.length > 0) {
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('q', query);
                window.history.pushState({}, '', currentUrl);
            }
            
            if (query.length > 2) {
                window.location.href = '/search?q=' + encodeURIComponent(query);
            }
        }

        // Handle enter key in search box
        document.querySelector('.search-box').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query.length > 0) {
                    window.location.href = '/search?q=' + encodeURIComponent(query);
                }
            }
        });
    </script>
{% endblock %}